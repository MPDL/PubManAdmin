<div class="container" *ngIf="user">
    <div class="card text-white bg-primary text-end">
        <div class="card-body">
            <h4 class="card-title">{{user.loginname}}</h4>
        </div>
        
        <form class="list-group-item text-primary" name="form" (ngSubmit)="f.form.valid && saveUser()" #f="ngForm" novalidate>
            <div class="row w-100 mt-3">
                <label for="loginName" class="col-2 col-form-label col-form-label-sm">loginname</label>
                <div class="col-6">
                    <input class="form-control form-control-sm" type="text" name="loginname" [(ngModel)]="user.loginname" id="loginName" required minlength="4" value-not-allowed="new user" #loginname="ngModel" [readonly]="!isNewUser">
                    <div *ngIf="loginname.invalid && (loginname.dirty || loginname.touched)" class="text-danger">
                        <div *ngIf="loginname.errors.required">
                            loginname is required.
                        </div>
                        <div *ngIf="loginname.errors.minlength">
                            loginname must be at least 4 characters long.
                        </div>
                        <div *ngIf="loginname.errors.value-not-allowed">
                            loginname MUST NOT be new user.
                        </div>
                    </div>
                </div>
                <label *ngIf="!isNewUser" for="userId" class="col-1 col-form-label col-form-label-sm">id</label>
                <div *ngIf="!isNewUser" class="col-3">
                    <input class="form-control form-control-sm" type="text" name="id" [(ngModel)]="user.objectId" id="userId" readonly>
                </div>
            </div>

            <div class="row w-100 mt-3">
                <label for="password" class="col-2 col-form-label col-form-label-sm">password</label>
                <div class="col-6">
                    <input class="form-control form-control-sm" type="password" name="password" [(ngModel)]="user.password" id="password" readonly>
                </div>
                <div *ngIf="!isNewUser && user.active == true && user.password" class="col-4">
                    <input type="button" class="btn btn-outline-primary btn-sm float-end" (click)="resetPassword(user)" name="resetPassword" value="save" />
                    <input type="button" class="btn btn-outline-primary btn-sm float-end" (click)="generateRandomPassword(user)" name="generatePassword" value="generate" />
                </div>
                <div *ngIf="user.active == true && !user.password" class="col-4">
                    <input type="button" class="btn btn-outline-primary btn-sm float-end" (click)="generateRandomPassword(user)" name="generatePassword" value="generate" />
                </div>
            </div>

            <div *ngIf="isNewUser" class="row w-100 mt-3">
                <label class="col-2 col-form-label col-form-label-sm">active</label>
                <div class="col-6">
                    <select class="select form-select form-select-sm" [(ngModel)]="user.active" name="active">
	    			<option [ngValue]>true</option>
	    			<option [ngValue]>false</option>
    			</select>
                </div>
            </div>

            <div *ngIf="!isNewUser" class="row w-100 mt-3">
                <label for="active" class="col-2 col-form-label col-form-label-sm">active</label>
                <div class="col-6">
                    <input class="form-control form-control-sm" type="text" name="active" [(ngModel)]="user.active" id="active" readonly>
                </div>
                <div class="col-4">
                    <input type="button" class="btn btn-outline-primary btn-sm float-end" (click)="activateUser(user)" name="activate" [value]="user.active === false ? 'activate' : 'deactivate'" />
                </div>
            </div>

            <div class="row w-100 mt-3">
                <label for="name" class="col-2 col-form-label col-form-label-sm">name</label>
                <div class="col-10">
                    <input class="form-control form-control-sm" type="text" name="name" [(ngModel)]="user.name" id="name" required #name="ngModel">
                    <div *ngIf="name.invalid && (name.dirty || name.touched)" class="text-danger">
                        <div *ngIf="name.errors.required">
                            name is required.
                        </div>
                    </div>
                </div>
            </div>

            <div class="row w-100 mt-3">
                <label for="email" class="col-2 col-form-label col-form-label-sm">email</label>
                <div class="col-10">
                    <input class="form-control form-control-sm" type="email" name="email" [(ngModel)]="user.email" id="email">
                </div>
            </div>

            <div *ngIf="!isNewOu" class="row w-100 mt-3">
                <label for="selectedOu" class="col-2 col-form-label col-form-label-sm">organization</label>
                <div *ngIf="user.affiliation" class="col-6">
                    <input class="form-control form-control-sm" type="text" name="ouid" [(ngModel)]="user.affiliation.name" id="selectedOu" readonly>
                </div>
                <div *ngIf="user.active === true" class="col-4">
                    <input type="button" class="btn btn-outline-primary btn-sm float-end" (click)="changeOu()" name="changeOu" value="change" />
                </div>
            </div>

            <div *ngIf="isNewUser || isNewOu" class="row w-100 mt-3">
                <label for="ouSearchTerm" class="col-2 col-form-label col-form-label-sm">organization</label>
                <div class="col-10">
                    <input class="form-control form-control-sm" type="text" name="ouSearchTerm" [(ngModel)]="ouSearchTerm" (keyup)="getOus(ouSearchTerm)" placeholder="search by name of organization" id="ouSearchTerm" autocomplete="off">
                    <div *ngIf="ous.length > 0">
                        <ul id="ouSuggestions" class="list-group" (clickOutside)="closeOus()">
                            <li *ngFor="let ou of ous" class="list-group-item-primary list-group-item-action py-0 text-start" (click)="selectOu(ou)">
                                <small>{{ou.name}}</small>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="row w-100 mt-3">
                <div class="col-3 ms-auto">
                    <input type="button" class="btn btn-outline-primary btn-sm me-2" name="cancel" value="cancel" (click)="gotoUserList()" />
                    <input *ngIf="!isNewUser && isAdmin" type="button" class="btn btn-outline-primary btn-sm me-2" name="deleteUser" value="delete" (click)="deleteUser(user)" />
                    <input type="button" class="btn btn-outline-primary btn-sm" name="saveUser" value="save" (click)="saveUser(user)" />
                </div>
            </div>

            <div *ngIf="!isNewUser" class="w-100">
                <div class="row w-100 mt-5">
                    <label for="addGrantButton" class="col-2 col-form-label col-form-label-sm">grants</label>
                    <div class="col-10 text-end">
                        <ul class="list-group">
                            <li class="list-group-item-primary list-group-item-action py-0 align-items-center" *ngFor="let grant of user.grantList" (click)="goToRef(grant)">
                                <div class="row">
                                    <span class="col-4 text-start text-truncate">
                                        <label class="col-form-label-sm p-0 ms-2" [innerHtml]="grant.role"></label>
                                    </span>
                                    <span class="col-6 text-start text-truncate">
                                        <label class="col-form-label-sm p-0" [innerHtml]="grant.objectName"></label>
                                    </span>
                                    <span class="col-1 text-start">
                                        <label class="col-form-label-sm p-0" [innerHtml]="grant.objectRef"></label>
                                    </span>
                                    <span class="col-1">
                                        <input type="button" class="btn btn-outline-primary btn-sm" (click)="addToDeleteGrantsList(grant); $event.stopPropagation()" name="addToDeleteGrantsList" value="x" />
                                    </span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <div *ngIf="!isNewGrant && user.active === true" class="row w-100 mt-3">
                    <div class="col-2 ms-auto">
                        <input type="button" class="btn btn-outline-primary btn-sm float-end" (click)="addGrant(); $event.stopPropagation()" name="addGrant" value="add grants" />
                    </div>
                </div>

                <div *ngIf="isNewGrant" class="row w-100 mt-3">
                    <div class="col-10 ms-auto">
                        <grants-component class="row w-100 mt-3" [(isNewGrant)]="isNewGrant" [(user)]="user" [token]="token" ></grants-component>
                    </div>
                </div>

                <div *ngIf="grants2remove" class="row w-100 mt-3">
                    <div class="col-10 ms-auto">
                        <div class="row w-100 mt-3">
                            <div class="container">
                                <div class="row w-100">
                                    <div class="col-11">
                                        <textarea class="form-control form-control-sm" rows="3" name="grantsToRemove" [(ngModel)]="grantsToRemove" readonly></textarea>
                                    </div>
                                    <div class="col-1">
                                        <input type="button" class="btn btn-outline-primary btn-sm float-start" name="removeGrants" value="remove grants" (click)="removeGrants()" />
                                        <input *ngIf="grantsToRemove" type="button" class="btn btn-outline-primary btn-sm float-start mt-1" name="reset" value="cancel" (click)="resetGrants()" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>